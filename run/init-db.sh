#!/bin/bash
set -e

psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<-EOSQL
    CREATE DATABASE WM_PGDB;
    CREATE SCHEMA WM_PGDB_schema;


    SET search_path TO WM_PGDB_schema;

    CREATE USER WM_PGDB_user;
    ALTER USER WM_PGDB_user WITH ENCRYPTED PASSWORD 'manage';

    ALTER USER WM_PGDB_user SET search_path = WM_PGDB_schema;

    GRANT CONNECT ON DATABASE WM_PGDB TO WM_PGDB_user;
    GRANT USAGE, CREATE ON SCHEMA WM_PGDB_schema TO WM_PGDB_user;
    GRANT ALL ON SCHEMA WM_PGDB_schema TO WM_PGDB_user;

    ALTER DEFAULT PRIVILEGES IN SCHEMA WM_PGDB_schema GRANT ALL ON TABLES TO WM_PGDB_user;
    ALTER DEFAULT PRIVILEGES IN SCHEMA WM_PGDB_schema GRANT ALL ON SEQUENCES TO WM_PGDB_user;
    ALTER DEFAULT PRIVILEGES IN SCHEMA WM_PGDB_schema GRANT ALL ON FUNCTIONS TO WM_PGDB_user;
    ALTER DEFAULT PRIVILEGES IN SCHEMA WM_PGDB_schema GRANT ALL ON TYPES TO WM_PGDB_user;
EOSQL